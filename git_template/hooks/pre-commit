#!/bin/bash

# Pre-commit hook to check and fix trailing whitespace
# This hook will:
# 1. Check for trailing whitespace in staged files
# 2. Automatically fix it if found
# 3. Re-stage the cleaned files
# 4. Continue with the commit

set -e

echo "ğŸ” Checking for trailing whitespace..."

# Get list of staged files (only text files we care about)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rb|go|sh|md|txt|yml|yaml|json|js|ts|css|html)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No relevant files to check"
else
    # Check for trailing whitespace
    WHITESPACE_FILES=()
    for file in $STAGED_FILES; do
        if [ -f "$file" ] && grep -qE '[[:space:]]+$' "$file"; then
            WHITESPACE_FILES+=("$file")
        fi
    done


    if [ ${#WHITESPACE_FILES[@]} -eq 0 ]; then
        echo "âœ… No trailing whitespace found"
    else
        echo "ğŸ§¹ Found trailing whitespace in ${#WHITESPACE_FILES[@]} file(s):"
        for file in "${WHITESPACE_FILES[@]}"; do
            echo "   - $file"
        done

        echo "ğŸ”§ Automatically fixing trailing whitespace..."

        # Fix trailing whitespace
        for file in "${WHITESPACE_FILES[@]}"; do
            # Remove trailing whitespace
            sed -i '' 's/[[:space:]]*$//' "$file"

            # Ensure file ends with newline
            if [ -s "$file" ] && [ "$(tail -c1 "$file")" != "" ]; then
                echo "" >> "$file"
            fi
            # Re-stage the fixed file
            git add "$file"
            echo "   âœ… Fixed: $file"
        done

        echo "âœ¨ All files cleaned and re-staged"
        echo "ğŸ’¡ Continuing with commit..."
    fi
fi

# Run StandardRB on Ruby files
echo "ğŸ” Running StandardRB..."
RUBY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rb$' || true)

if [ -n "$RUBY_FILES" ]; then
    echo "ğŸ”§ Running standardrb --fix on staged Ruby files..."
    if bundle exec standardrb --fix $RUBY_FILES; then
        # Re-stage the fixed files
        git add $RUBY_FILES
        echo "âœ… StandardRB fixes applied and re-staged"
    else
        echo "âŒ StandardRB found issues that couldn't be auto-fixed"
        echo "ğŸ’¡ Please fix the remaining issues and commit again"
        exit 1
    fi
else
    echo "âœ… No Ruby files to check"
fi

local_hook="$HOME"/.git_template.local/hooks/pre-commit

if [ -f "$local_hook" ]; then
  . "$local_hook"
fi
